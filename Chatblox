local pcall = pcall
pcall(function()
local UIS = game:GetService("UserInputService")
local CG = game:GetService("CoreGui")
local LP = game:GetService("Players").LocalPlayer
local TS = game:GetService("TweenService")
local HS = game:GetService("HttpService")
local Http = (syn and syn.request) or (http and http.request) or http_request or request
local db_url = "https://chatblox-56845-default-rtdb.firebaseio.com/.json"
local lastClear = tick()
local startTime = os.time()
local fileName = "ChatBlox_Pos.txt"

pcall(function() if CG:FindFirstChild("ChatBloxFinalSystem") then CG.ChatBloxFinalSystem:Destroy() end end)

local defH = UDim2.new(0.7, 0, 0.1, 0)
local defM = UDim2.new(0.71, 0, 0.36, 0)

local sg = Instance.new("ScreenGui")
pcall(function() sg.Name = "ChatBloxFinalSystem" end)
pcall(function() sg.ResetOnSpawn = false end)
pcall(function() sg.IgnoreGuiInset = true end)
pcall(function() sg.Parent = CG end)

local hCont = Instance.new("Frame")
pcall(function() hCont.Size = UDim2.new(0.2, 0, 0.25, 0) end)
pcall(function() hCont.Position = defH end)
pcall(function() hCont.BackgroundTransparency = 1 end)
pcall(function() hCont.Parent = sg end)

local history = Instance.new("ScrollingFrame")
pcall(function() history.Size = UDim2.new(1, 0, 1, 0) end)
pcall(function() history.BackgroundColor3 = Color3.fromRGB(0, 0, 0) end)
pcall(function() history.BackgroundTransparency = 0.8 end)
pcall(function() history.BorderSizePixel = 0 end)
pcall(function() history.ScrollBarThickness = 2 end)
pcall(function() history.CanvasSize = UDim2.new(0, 0, 0, 0) end)
pcall(function() history.AutomaticCanvasSize = Enum.AutomaticSize.Y end)
pcall(function() history.Parent = hCont end)

local dragH = Instance.new("TextButton")
pcall(function() dragH.Size = UDim2.new(0.1, 0, 0.1, 0) end)
pcall(function() dragH.Position = UDim2.new(0.9, 0, 0, 0) end)
pcall(function() dragH.BackgroundTransparency = 1 end)
pcall(function() dragH.Text = "+" end)
pcall(function() dragH.TextColor3 = Color3.new(1, 1, 1) end)
pcall(function() dragH.TextScaled = true end)
pcall(function() dragH.Font = Enum.Font.GothamBold end)
pcall(function() dragH.ZIndex = 5 end)
pcall(function() dragH.Parent = hCont end)

local layout = Instance.new("UIListLayout")
pcall(function() layout.SortOrder = Enum.SortOrder.LayoutOrder end)
pcall(function() layout.VerticalAlignment = Enum.VerticalAlignment.Bottom end)
pcall(function() layout.Padding = UDim.new(0.01, 0) end)
pcall(function() layout.Parent = history end)

local main = Instance.new("Frame")
pcall(function() main.Size = UDim2.new(0.18, 0, 0.045, 0) end)
pcall(function() main.Position = defM end)
pcall(function() main.BackgroundColor3 = Color3.fromRGB(25, 27, 29) end)
pcall(function() main.BackgroundTransparency = 0.2 end)
pcall(function() main.ClipsDescendants = true end)
pcall(function() main.Parent = sg end)

local dragM = Instance.new("TextLabel")
pcall(function() dragM.Size = UDim2.new(0.1, 0, 1, 0) end)
pcall(function() dragM.BackgroundTransparency = 1 end)
pcall(function() dragM.Text = "+" end)
pcall(function() dragM.TextColor3 = Color3.new(1, 1, 1) end)
pcall(function() dragM.TextScaled = true end)
pcall(function() dragM.Font = Enum.Font.GothamBold end)
pcall(function() dragM.Parent = main end)

local tb = Instance.new("TextBox")
pcall(function() tb.Size = UDim2.new(0.7, 0, 1, 0) end)
pcall(function() tb.Position = UDim2.new(0.12, 0, 0, 0) end)
pcall(function() tb.BackgroundTransparency = 1 end)
pcall(function() tb.Text = "" end)
pcall(function() tb.PlaceholderText = "Escribir..." end)
pcall(function() tb.Font = Enum.Font.GothamMedium end)
pcall(function() tb.TextScaled = true end)
pcall(function() tb.TextColor3 = Color3.new(1, 1, 1) end)
pcall(function() tb.TextXAlignment = Enum.TextXAlignment.Left end)
pcall(function() tb.ClearTextOnFocus = false end)
pcall(function() tb.Parent = main end)

local send = Instance.new("TextButton")
pcall(function() send.Size = UDim2.new(0.15, 0, 0.7, 0) end)
pcall(function() send.Position = UDim2.new(0.83, 0, 0.15, 0) end)
pcall(function() send.BackgroundColor3 = Color3.fromRGB(0, 170, 255) end)
pcall(function() send.Text = "OK" end)
pcall(function() send.TextScaled = true end)
pcall(function() send.Font = Enum.Font.GothamBold end)
pcall(function() send.TextColor3 = Color3.new(1, 1, 1) end)
pcall(function() send.Parent = main end)

local reset = Instance.new("TextButton")
pcall(function() reset.Size = UDim2.new(0.08, 0, 0.04, 0) end)
pcall(function() reset.Position = UDim2.new(0.01, 0, 0.95, 0) end)
pcall(function() reset.BackgroundColor3 = Color3.fromRGB(50, 50, 50) end)
pcall(function() reset.BackgroundTransparency = 0.3 end)
pcall(function() reset.Text = "RESTAURAR" end)
pcall(function() reset.TextScaled = true end)
pcall(function() reset.TextColor3 = Color3.new(1, 1, 1) end)
pcall(function() reset.Font = Enum.Font.GothamBold end)
pcall(function() reset.Parent = sg end)
pcall(function() Instance.new("UICorner", reset).CornerRadius = UDim.new(0.2, 0) end)

local function save()
    pcall(function()
        local data = {
            hx = hCont.Position.X.Scale, ho = hCont.Position.X.Offset,
            hy = hCont.Position.Y.Scale, hv = hCont.Position.Y.Offset,
            mx = main.Position.X.Scale, mo = main.Position.X.Offset,
            my = main.Position.Y.Scale, mv = main.Position.Y.Offset
        }
        writefile(fileName, HS:JSONEncode(data))
    end)
end

local function load()
    pcall(function()
        if isfile(fileName) then
            local data = HS:JSONDecode(readfile(fileName))
            hCont.Position = UDim2.new(data.hx, data.ho, data.hy, data.hv)
            main.Position = UDim2.new(data.mx, data.mo, data.my, data.mv)
        end
    end)
end
pcall(load)

pcall(function()
    reset.MouseButton1Click:Connect(function()
        pcall(function()
            hCont.Position = defH
            main.Position = defM
            if isfile(fileName) then delfile(fileName) end
            save()
        end)
    end)
end)

local function applyDrag(f, h)
    local d, s, p
    h.InputBegan:Connect(function(input)
        pcall(function()
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                d = true s = input.Position p = f.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then d = false save() end
                end)
            end
        end)
    end)
    UIS.InputChanged:Connect(function(input)
        pcall(function()
            if d and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - s
                f.Position = UDim2.new(p.X.Scale, p.X.Offset + delta.X, p.Y.Scale, p.Y.Offset + delta.Y)
            end
        end)
    end)
end
pcall(function() applyDrag(hCont, dragH) end)
pcall(function() applyDrag(main, dragM) end)

local function showMsg(user, txt, uid)
    pcall(function()
        local c = Instance.new("Frame")
        pcall(function() c.Size = UDim2.new(1, 0, 0, 0) end)
        pcall(function() c.AutomaticSize = Enum.AutomaticSize.Y end)
        pcall(function() c.BackgroundTransparency = 1 end)
        pcall(function() c.Parent = history end)
        
        local img = Instance.new("ImageLabel")
        pcall(function() img.Size = UDim2.new(0, 18, 0, 18) end)
        pcall(function() img.Position = UDim2.new(0, 2, 0, 2) end)
        pcall(function() img.Image = "rbxthumb://type=AvatarHeadShot&id="..uid.."&w=150&h=150" end)
        pcall(function() img.BackgroundTransparency = 1 end)
        pcall(function() img.Parent = c end)
        
        local ic = Instance.new("UICorner")
        pcall(function() ic.CornerRadius = UDim.new(1, 0) end)
        pcall(function() ic.Parent = img end)

        local nCol = Color3.fromHSV((uid % 100) / 100, 0.7, 1)
        local m = Instance.new("TextLabel")
        pcall(function() m.Size = UDim2.new(1, -25, 0, 0) end)
        pcall(function() m.Position = UDim2.new(0, 25, 0, 2) end)
        pcall(function() m.AutomaticSize = Enum.AutomaticSize.Y end)
        pcall(function() m.BackgroundTransparency = 1 end)
        pcall(function() m.RichText = true end)
        pcall(function() m.Text = "<font color='#"..nCol:ToHex().."'><b>"..user..":</b></font> "..txt end)
        pcall(function() m.Font = Enum.Font.GothamMedium end)
        pcall(function() m.TextSize = 13 end)
        pcall(function() m.TextColor3 = Color3.new(1, 1, 1) end)
        pcall(function() m.TextXAlignment = Enum.TextXAlignment.Left end)
        pcall(function() m.TextWrapped = true end)
        pcall(function() m.Parent = c end)
        
        history.CanvasPosition = Vector2.new(0, 99999)
    end)
end

local function post()
    pcall(function()
        if tb.Text ~= "" then
            local data = HS:JSONEncode({user = LP.DisplayName, content = tb.Text, userId = LP.UserId, time = os.time()})
            Http({Url = db_url, Method = "POST", Body = data})
            tb.Text = ""
        end
    end)
end
pcall(function() send.MouseButton1Click:Connect(post) end)
pcall(function() tb.FocusLost:Connect(function(e) if e then post() end end) end)

task.spawn(function()
    while task.wait(3) do
        pcall(function()
            if tick() - lastClear >= 300 then Http({Url = db_url, Method = "DELETE"}) lastClear = tick() end
            local res = Http({Url = db_url, Method = "GET"})
            if res.Success then
                local data = HS:JSONDecode(res.Body)
                if data then
                    local lId = "" local lD = nil
                    for id, msg in pairs(data) do if id > lId then lId = id lD = msg end end
                    if lId ~= lastMsg and lD and lD.time > startTime then lastMsg = lId showMsg(lD.user, lD.content, lD.userId or 1) end
                else lastMsg = "" end
            end
        end)
    end
end)
end)
